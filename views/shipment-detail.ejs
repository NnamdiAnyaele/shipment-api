<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | ShipTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/stylesheets/style.css" rel="stylesheet">
</head>
<body class="d-flex flex-column min-vh-100 bg-light">
  <%- include('partials/header') %>

  <main class="flex-grow-1 py-4">
    <div class="container">
      <!-- Breadcrumb -->
      <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
          <li class="breadcrumb-item"><a href="/shipments">Shipments</a></li>
          <li class="breadcrumb-item active" id="breadcrumbTracking">Loading...</li>
        </ol>
      </nav>

      <!-- Shipment Header -->
      <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <div class="d-flex align-items-center mb-2">
                <h1 class="h3 mb-0 me-3" id="trackingNumber">Loading...</h1>
                <span id="statusBadge"></span>
              </div>
              <p class="text-muted mb-0">
                <i class="bi bi-calendar me-1"></i>
                Created: <span id="createdDate">-</span>
              </p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
              <div class="btn-group">
                <a href="/shipments/edit/<%= shipmentId %>" class="btn btn-outline-primary" id="editBtn">
                  <i class="bi bi-pencil me-1"></i>Edit
                </a>
                <button type="button" class="btn btn-outline-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                  <span class="visually-hidden">More actions</span>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li><a class="dropdown-item" href="#" id="updateStatusBtn"><i class="bi bi-arrow-repeat me-2"></i>Update Status</a></li>
                  <li><a class="dropdown-item" href="#" id="addAttachmentBtn"><i class="bi bi-paperclip me-2"></i>Add Attachment</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li><a class="dropdown-item text-danger" href="#" id="deleteShipmentBtn"><i class="bi bi-trash me-2"></i>Delete Shipment</a></li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-4">
        <!-- Main Details -->
        <div class="col-lg-8">
          <!-- Sender & Receiver -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="bi bi-people text-primary me-2"></i>Shipment Parties</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3 mb-md-0">
                  <div class="d-flex">
                    <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-3 p-3 me-3">
                      <i class="bi bi-box-arrow-up text-primary fs-5"></i>
                    </div>
                    <div>
                      <small class="text-muted">Sender</small>
                      <h6 class="mb-1" id="senderName">-</h6>
                      <p class="mb-0 text-muted" id="origin">-</p>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="d-flex">
                    <div class="flex-shrink-0 bg-success bg-opacity-10 rounded-3 p-3 me-3">
                      <i class="bi bi-box-arrow-in-down text-success fs-5"></i>
                    </div>
                    <div>
                      <small class="text-muted">Receiver</small>
                      <h6 class="mb-1" id="receiverName">-</h6>
                      <p class="mb-0 text-muted" id="destination">-</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Status History -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="bi bi-clock-history text-primary me-2"></i>Status History</h5>
            </div>
            <div class="card-body" id="statusHistoryContainer">
              <div class="text-center py-4">
                <div class="spinner-border spinner-border-sm text-primary"></div>
              </div>
            </div>
          </div>

          <!-- Attachments -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h5 class="mb-0"><i class="bi bi-paperclip text-primary me-2"></i>Attachments</h5>
              <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#attachmentModal">
                <i class="bi bi-plus-lg"></i>
              </button>
            </div>
            <div class="card-body" id="attachmentsContainer">
              <p class="text-muted mb-0">No attachments</p>
            </div>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
          <!-- Shipment Details -->
          <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="bi bi-info-circle text-primary me-2"></i>Details</h5>
            </div>
            <div class="card-body">
              <table class="table table-borderless mb-0">
                <tr>
                  <td class="text-muted">Weight</td>
                  <td class="text-end fw-medium" id="weight">-</td>
                </tr>
                <tr>
                  <td class="text-muted">Est. Delivery</td>
                  <td class="text-end fw-medium" id="estimatedDelivery">-</td>
                </tr>
                <tr>
                  <td class="text-muted">Actual Delivery</td>
                  <td class="text-end fw-medium" id="actualDelivery">-</td>
                </tr>
                <tr>
                  <td class="text-muted">Days in Transit</td>
                  <td class="text-end fw-medium" id="daysInTransit">-</td>
                </tr>
                <tr>
                  <td class="text-muted">Created By</td>
                  <td class="text-end fw-medium" id="createdBy">-</td>
                </tr>
              </table>
            </div>
          </div>

          <!-- Description -->
          <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
              <h5 class="mb-0"><i class="bi bi-text-paragraph text-primary me-2"></i>Description</h5>
            </div>
            <div class="card-body">
              <p class="mb-0" id="description">No description provided</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Update Status Modal -->
  <div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Update Status</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="statusForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="newStatus" class="form-label">New Status</label>
              <select class="form-select" id="newStatus" required>
                <option value="pending">Pending</option>
                <option value="in_transit">In Transit</option>
                <option value="delivered">Delivered</option>
                <option value="cancelled">Cancelled</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="statusNotes" class="form-label">Notes (optional)</label>
              <textarea class="form-control" id="statusNotes" rows="3" placeholder="Add notes about this status change..."></textarea>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Update Status</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Add Attachment Modal -->
  <div class="modal fade" id="attachmentModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Add Attachment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <form id="attachmentForm">
          <div class="modal-body">
            <div class="mb-3">
              <label for="attachmentFile" class="form-label">Select File</label>
              <input type="file" class="form-control" id="attachmentFile" required accept=".jpg,.jpeg,.png,.gif,.pdf">
              <small class="text-muted">Max 5MB. Supported: images, PDF</small>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Upload</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Delete Shipment</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p>Are you sure you want to delete this shipment? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <%- include('partials/footer') %>
  <%- include('partials/scripts') %>

  <script>
    const shipmentId = '<%= shipmentId %>';
    let shipmentData = null;

    document.addEventListener('DOMContentLoaded', async function() {
      if (!Auth.requireAuth()) return;

      await loadShipment();

      // Event listeners
      document.getElementById('updateStatusBtn').addEventListener('click', () => {
        if (shipmentData) {
          document.getElementById('newStatus').value = shipmentData.status;
        }
        new bootstrap.Modal(document.getElementById('statusModal')).show();
      });

      document.getElementById('addAttachmentBtn').addEventListener('click', () => {
        new bootstrap.Modal(document.getElementById('attachmentModal')).show();
      });

      document.getElementById('deleteShipmentBtn').addEventListener('click', () => {
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
      });

      document.getElementById('statusForm').addEventListener('submit', handleStatusUpdate);
      document.getElementById('attachmentForm').addEventListener('submit', handleAttachmentUpload);
      document.getElementById('confirmDeleteBtn').addEventListener('click', handleDelete);
    });

    async function loadShipment() {
      try {
        App.showLoading();
        const response = await Api.get(`/shipments/${shipmentId}`);
        
        if (response.success) {
          shipmentData = response.data;
          renderShipment(shipmentData);
        } else {
          App.showToast('Shipment not found', 'error');
          setTimeout(() => window.location.href = '/shipments', 2000);
        }
      } catch (error) {
        App.showToast(error.message || 'Failed to load shipment', 'error');
      } finally {
        App.hideLoading();
      }
    }

    function renderShipment(shipment) {
      document.getElementById('breadcrumbTracking').textContent = shipment.trackingNumber;
      document.getElementById('trackingNumber').textContent = shipment.trackingNumber;
      document.getElementById('statusBadge').innerHTML = App.getStatusBadge(shipment.status);
      document.getElementById('createdDate').textContent = App.formatDate(shipment.createdAt);
      
      document.getElementById('senderName').textContent = shipment.senderName;
      document.getElementById('receiverName').textContent = shipment.receiverName;
      document.getElementById('origin').textContent = shipment.origin;
      document.getElementById('destination').textContent = shipment.destination;
      
      document.getElementById('weight').textContent = shipment.weight ? `${shipment.weight} kg` : '-';
      document.getElementById('estimatedDelivery').textContent = shipment.estimatedDelivery ? App.formatDate(shipment.estimatedDelivery) : '-';
      document.getElementById('actualDelivery').textContent = shipment.actualDelivery ? App.formatDate(shipment.actualDelivery) : '-';
      document.getElementById('daysInTransit').textContent = shipment.daysInTransit || 0;
      document.getElementById('createdBy').textContent = shipment.createdBy?.name || '-';
      document.getElementById('description').textContent = shipment.description || 'No description provided';

      // Render status history
      renderStatusHistory(shipment.statusHistory || []);

      // Render attachments
      renderAttachments(shipment.attachments || []);

      // Disable delete for non-deletable statuses
      if (shipment.status !== 'pending' && shipment.status !== 'cancelled') {
        document.getElementById('deleteShipmentBtn').classList.add('disabled');
      }
    }

    function renderStatusHistory(history) {
      const container = document.getElementById('statusHistoryContainer');
      
      if (history.length === 0) {
        container.innerHTML = '<p class="text-muted mb-0">No status history</p>';
        return;
      }

      // Reverse to show newest first
      const sortedHistory = [...history].reverse();

      container.innerHTML = `
        <div class="timeline">
          ${sortedHistory.map((item, index) => `
            <div class="timeline-item ${index === 0 ? 'active' : ''}">
              <div class="timeline-marker bg-${getStatusColor(item.status)}"></div>
              <div class="timeline-content">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    ${App.getStatusBadge(item.status)}
                    ${item.notes ? `<p class="mb-0 mt-2 text-muted small">${App.escapeHtml(item.notes)}</p>` : ''}
                  </div>
                  <small class="text-muted">${App.formatDateTime(item.changedAt)}</small>
                </div>
                ${item.changedBy?.name ? `<small class="text-muted">by ${item.changedBy.name}</small>` : ''}
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function renderAttachments(attachments) {
      const container = document.getElementById('attachmentsContainer');
      
      if (attachments.length === 0) {
        container.innerHTML = '<p class="text-muted mb-0">No attachments</p>';
        return;
      }

      container.innerHTML = `
        <div class="row g-2">
          ${attachments.map(att => `
            <div class="col-md-6">
              <div class="d-flex align-items-center p-2 border rounded">
                <i class="bi bi-${getFileIcon(att.mimetype)} fs-4 text-muted me-2"></i>
                <div class="flex-grow-1 overflow-hidden">
                  <p class="mb-0 text-truncate small">${App.escapeHtml(att.originalName)}</p>
                  <small class="text-muted">${formatFileSize(att.size)}</small>
                </div>
                <div class="btn-group btn-group-sm">
                  <a href="${att.path}" target="_blank" class="btn btn-outline-secondary" title="View">
                    <i class="bi bi-eye"></i>
                  </a>
                  <button type="button" class="btn btn-outline-danger" title="Delete" onclick="deleteAttachment('${att._id}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    function getStatusColor(status) {
      const colors = {
        pending: 'warning',
        in_transit: 'info',
        delivered: 'success',
        cancelled: 'danger'
      };
      return colors[status] || 'secondary';
    }

    function getFileIcon(mimetype) {
      if (mimetype?.includes('image')) return 'file-image';
      if (mimetype?.includes('pdf')) return 'file-pdf';
      return 'file-earmark';
    }

    function formatFileSize(bytes) {
      if (!bytes) return '0 B';
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(1024));
      return (bytes / Math.pow(1024, i)).toFixed(1) + ' ' + sizes[i];
    }

    async function handleStatusUpdate(e) {
      e.preventDefault();
      
      const status = document.getElementById('newStatus').value;
      const notes = document.getElementById('statusNotes').value.trim();

      try {
        const response = await Api.patch(`/shipments/${shipmentId}/status`, { status, notes });
        
        if (response.success) {
          App.showToast('Status updated successfully', 'success');
          bootstrap.Modal.getInstance(document.getElementById('statusModal')).hide();
          shipmentData = response.data;
          renderShipment(shipmentData);
        } else {
          App.showToast(response.message || 'Failed to update status', 'error');
        }
      } catch (error) {
        App.showToast(error.message || 'An error occurred', 'error');
      }
    }

    async function handleAttachmentUpload(e) {
      e.preventDefault();
      
      const fileInput = document.getElementById('attachmentFile');
      if (!fileInput.files.length) return;

      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      try {
        const response = await Api.upload(`/shipments/${shipmentId}/attachments`, formData);
        
        if (response.success) {
          App.showToast('Attachment uploaded successfully', 'success');
          bootstrap.Modal.getInstance(document.getElementById('attachmentModal')).hide();
          fileInput.value = '';
          shipmentData = response.data;
          renderAttachments(shipmentData.attachments);
        } else {
          App.showToast(response.message || 'Failed to upload attachment', 'error');
        }
      } catch (error) {
        App.showToast(error.message || 'An error occurred', 'error');
      }
    }

    async function deleteAttachment(attachmentId) {
      if (!confirm('Are you sure you want to delete this attachment?')) return;

      try {
        const response = await Api.delete(`/shipments/${shipmentId}/attachments/${attachmentId}`);
        
        if (response.success) {
          App.showToast('Attachment deleted', 'success');
          shipmentData = response.data;
          renderAttachments(shipmentData.attachments);
        } else {
          App.showToast(response.message || 'Failed to delete attachment', 'error');
        }
      } catch (error) {
        App.showToast(error.message || 'An error occurred', 'error');
      }
    }

    async function handleDelete() {
      try {
        const response = await Api.delete(`/shipments/${shipmentId}`);
        
        if (response.success) {
          App.showToast('Shipment deleted successfully', 'success');
          setTimeout(() => window.location.href = '/shipments', 1500);
        } else {
          App.showToast(response.message || 'Failed to delete shipment', 'error');
        }
      } catch (error) {
        App.showToast(error.message || 'An error occurred', 'error');
      }
    }
  </script>
</body>
</html>
