<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> | ShipTrack</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.css" rel="stylesheet">
  <link href="/stylesheets/style.css" rel="stylesheet">
</head>
<body class="d-flex flex-column min-vh-100 bg-light">
  <%- include('partials/header') %>

  <main class="flex-grow-1 py-4">
    <div class="container">
      <!-- Welcome Section -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h1 class="h3 mb-1">Welcome back, <span id="userName">User</span>!</h1>
          <p class="text-muted mb-0">Here's your shipment overview</p>
        </div>
        <a href="/shipments/new" class="btn btn-primary">
          <i class="bi bi-plus-lg me-2"></i>New Shipment
        </a>
      </div>

      <!-- Stats Cards -->
      <div class="row g-4 mb-4">
        <div class="col-sm-6 col-xl-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 bg-primary bg-opacity-10 rounded-3 p-3">
                  <i class="bi bi-box-seam text-primary fs-4"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <p class="text-muted mb-1">Total Shipments</p>
                  <h3 class="mb-0" id="statTotal">-</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-xl-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 bg-warning bg-opacity-10 rounded-3 p-3">
                  <i class="bi bi-hourglass-split text-warning fs-4"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <p class="text-muted mb-1">Pending</p>
                  <h3 class="mb-0" id="statPending">-</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-xl-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 bg-info bg-opacity-10 rounded-3 p-3">
                  <i class="bi bi-truck text-info fs-4"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <p class="text-muted mb-1">In Transit</p>
                  <h3 class="mb-0" id="statInTransit">-</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-sm-6 col-xl-3">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center">
                <div class="flex-shrink-0 bg-success bg-opacity-10 rounded-3 p-3">
                  <i class="bi bi-check-circle text-success fs-4"></i>
                </div>
                <div class="flex-grow-1 ms-3">
                  <p class="text-muted mb-1">Delivered</p>
                  <h3 class="mb-0" id="statDelivered">-</h3>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Shipments -->
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-white py-3">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Recent Shipments</h5>
            <a href="/shipments" class="btn btn-sm btn-outline-primary">View All</a>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-hover mb-0">
              <thead class="table-light">
                <tr>
                  <th>Tracking #</th>
                  <th>Sender</th>
                  <th>Receiver</th>
                  <th>Route</th>
                  <th>Status</th>
                  <th>Date</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody id="recentShipmentsTable">
                <tr>
                  <td colspan="7" class="text-center py-4">
                    <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                    Loading shipments...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="row g-4 mt-4">
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title mb-3">
                <i class="bi bi-search text-primary me-2"></i>Track a Shipment
              </h5>
              <form id="trackForm">
                <div class="input-group">
                  <input type="text" class="form-control" id="trackingInput" placeholder="Enter tracking number">
                  <button type="submit" class="btn btn-primary">Track</button>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card border-0 shadow-sm h-100">
            <div class="card-body">
              <h5 class="card-title mb-3">
                <i class="bi bi-lightning text-primary me-2"></i>Quick Actions
              </h5>
              <div class="d-flex flex-wrap gap-2">
                <a href="/shipments/new" class="btn btn-outline-primary">
                  <i class="bi bi-plus-lg me-1"></i>New Shipment
                </a>
                <a href="/shipments" class="btn btn-outline-primary">
                  <i class="bi bi-list me-1"></i>All Shipments
                </a>
                <a href="/profile" class="btn btn-outline-primary">
                  <i class="bi bi-person me-1"></i>My Profile
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>
  <%- include('partials/scripts') %>

  <script>
    document.addEventListener('DOMContentLoaded', async function() {
      // Require authentication
      if (!Auth.requireAuth()) return;

      // Display user name
      const user = Auth.getUser();
      if (user) {
        document.getElementById('userName').textContent = user.name.split(' ')[0];
      }

      // Load statistics
      await loadStats();

      // Load recent shipments
      await loadRecentShipments();

      // Track form
      document.getElementById('trackForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const trackingNumber = document.getElementById('trackingInput').value.trim();
        if (trackingNumber) {
          window.location.href = `/track?number=${encodeURIComponent(trackingNumber)}`;
        }
      });
    });

    async function loadStats() {
      try {
        const response = await Api.get('/shipments/my-stats');
        if (response.success) {
          const stats = response.data;
          document.getElementById('statTotal').textContent = stats.total || 0;
          document.getElementById('statPending').textContent = stats.pending || 0;
          document.getElementById('statInTransit').textContent = stats.in_transit || 0;
          document.getElementById('statDelivered').textContent = stats.delivered || 0;
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }

    async function loadRecentShipments() {
      const tableBody = document.getElementById('recentShipmentsTable');
      
      try {
        const response = await Api.get('/shipments', { limit: 5, sortBy: 'createdAt', sortOrder: 'desc' });
        
        if (response.success && response.data.length > 0) {
          tableBody.innerHTML = response.data.map(shipment => `
            <tr>
              <td>
                <a href="/shipments/view/${shipment._id}" class="text-decoration-none fw-medium">
                  ${shipment.trackingNumber}
                </a>
              </td>
              <td>${App.escapeHtml(shipment.senderName)}</td>
              <td>${App.escapeHtml(shipment.receiverName)}</td>
              <td>
                <small class="text-muted">
                  ${App.escapeHtml(shipment.origin)} â†’ ${App.escapeHtml(shipment.destination)}
                </small>
              </td>
              <td>${App.getStatusBadge(shipment.status)}</td>
              <td><small class="text-muted">${App.formatDate(shipment.createdAt)}</small></td>
              <td class="text-end">
                <div class="btn-group btn-group-sm">
                  <a href="/shipments/view/${shipment._id}" class="btn btn-outline-secondary" title="View">
                    <i class="bi bi-eye"></i>
                  </a>
                  <a href="/shipments/edit/${shipment._id}" class="btn btn-outline-secondary" title="Edit">
                    <i class="bi bi-pencil"></i>
                  </a>
                </div>
              </td>
            </tr>
          `).join('');
        } else {
          tableBody.innerHTML = `
            <tr>
              <td colspan="7" class="text-center py-4">
                <p class="mb-2 text-muted">No shipments yet</p>
                <a href="/shipments/new" class="btn btn-primary btn-sm">Create your first shipment</a>
              </td>
            </tr>
          `;
        }
      } catch (error) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="7" class="text-center py-4 text-danger">
              Failed to load shipments
            </td>
          </tr>
        `;
      }
    }
  </script>
</body>
</html>
